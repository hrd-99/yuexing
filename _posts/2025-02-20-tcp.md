---
title: 'tcp相关'
date: 2025-2-20
permalink: /posts/2025/02/tcp/
tags:
  - tcp
excerpt: ""  # 这里设置为空，阻止预览
---



<img src="https://hrd-99.github.io/yuexing/images/tcp三次握手.png" style="zoom: 33%;" />

不使用「两次握手」和「四次握手」的原因：

- 「两次握手」：无法防止历史连接的建立，会造成双方资源的浪费，也无法可靠的同步双方序列号；
- 「四次握手」：三次握手就已经理论上最少可靠连接建立，所以不需要使用更多的通信次数。

<img src="https://hrd-99.github.io/yuexing/images/tcp挥手.png" style="zoom: 33%;" />

| 特性           | TCP                                        | UDP                                      |
| -------------- | ------------------------------------------ | ---------------------------------------- |
| **全称**       | Transmission Control Protocol              | User Datagram Protocol                   |
| **连接方式**   | 面向连接（Connection-oriented）            | 无连接（Connectionless）                 |
| **可靠性**     | 可靠传输，确保数据不丢失、不重复、按序到达 | 不可靠传输，不保证数据到达或顺序         |
| **数据完整性** | 提供校验和、确认机制、重传机制             | 仅提供校验和，无确认和重传机制           |
| **速度**       | 较慢，因为需要建立连接、确认和重传         | 较快，因为无连接和确认机制               |
| **头部大小**   | 较大（20 字节 + 可选字段）                 | 较小（8 字节）                           |
| **流量控制**   | 支持（通过滑动窗口机制）                   | 不支持                                   |
| **拥塞控制**   | 支持（通过慢启动、拥塞避免等机制）         | 不支持                                   |
| **应用场景**   | 需要可靠传输的应用（如网页、文件传输）     | 需要快速传输的应用（如视频、语音、游戏） |





#### 流量控制(滑动窗口)

| 实现细节         | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| **发送窗口**     | 发送方维护一个发送窗口，表示可以发送的数据范围。             |
| **接收窗口**     | 接收方维护一个接收窗口，表示可以接收的数据范围。             |
| **窗口大小调整** | 接收方通过 ACK 报文告知发送方其接收窗口大小，发送方根据窗口大小调整发送速率。 |
| **零窗口探测**   | 当接收窗口为 0 时，发送方定期发送探测报文，检查接收窗口是否恢复。 |
| **窗口缩放**     | 通过窗口缩放选项（Window Scaling）支持更大的窗口大小（超过 64KB）。 |





#### 重传机制

| 超时重传         | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| **计时器**       | 发送方为每个数据包设置一个计时器，超时未收到确认则重传。     |
| **超时时间计算** | 超时时间基于 RTT（Round-Trip Time）动态计算，使用 Karn 算法和 Jacobson 算法。 |
| **指数退避**     | 每次超时后，超时时间加倍，避免频繁重传引发网络拥塞。         |

| 快速重传     | 描述                                                  |
| ------------ | ----------------------------------------------------- |
| **重复确认** | 接收方收到失序数据包时，立即发送重复确认（DUP ACK）。 |
| **触发条件** | 发送方收到 3 个重复确认后，立即重传丢失的数据包。     |
| **优点**     | 减少超时等待时间，提高重传效率。                      |

| SACK（选择性确认) | 描述                                                       |
| ----------------- | ---------------------------------------------------------- |
| **SACK 选项**     | 接收方通过 SACK 选项告知发送方已成功接收的数据块。         |
| **选择性重传**    | 发送方根据 SACK 信息只重传丢失的数据块，减少不必要的重传。 |
| **优点**          | 提高重传效率，减少带宽浪费。                               |

| DUP SACK（重复确认） | 描述                                           |
| -------------------- | ---------------------------------------------- |
| **重复确认**         | 接收方通过重复确认告知发送方数据包丢失或失序。 |
| **触发快速重传**     | 发送方根据重复确认信息触发快速重传。           |
| **优点**             | 提高重传效率，减少超时等待时间。               |





#### 拥塞控制

| 慢启动         | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| **初始窗口**   | 发送方从较小的拥塞窗口（通常为 1 MSS）开始。                 |
| **指数增长**   | 每收到一个 ACK，拥塞窗口大小翻倍，直到达到慢启动阈值（ssthresh）。 |
| **慢启动阈值** | 当检测到拥塞时，慢启动阈值设置为当前拥塞窗口的一半。         |

| 拥塞避免       | 描述                                                 |
| -------------- | ---------------------------------------------------- |
| **线性增长**   | 每收到一个 ACK，拥塞窗口增加 1 MSS，直到检测到拥塞。 |
| **慢启动阈值** | 当检测到拥塞时，慢启动阈值设置为当前拥塞窗口的一半。 |
| **目标**       | 缓慢增加拥塞窗口，避免引发拥塞。                     |

| 拥塞发生       | 描述                                                       |
| -------------- | ---------------------------------------------------------- |
| **超时检测**   | 当数据包超时未收到确认时，发送方认为网络发生拥塞。         |
| **窗口调整**   | 发送方将拥塞窗口减小为 1 MSS（慢启动）或一半（快速恢复）。 |
| **慢启动阈值** | 慢启动阈值设置为当前拥塞窗口的一半。                       |

| 快速恢复         | 描述                                                       |
| ---------------- | ---------------------------------------------------------- |
| **快速重传**     | 当收到 3 个重复确认时，发送方认为网络发生拥塞。            |
| **窗口调整**     | 发送方将拥塞窗口减小为一半，并进入快速恢复阶段。           |
| **快速恢复阶段** | 每收到一个重复确认，拥塞窗口增加 1 MSS，直到收到新的 ACK。 |
| **目标**         | 快速恢复发送速率，减少性能损失。                           |



**粘包**：多个数据包被合并成一个大的数据包。

**拆包**：一个数据包被拆分成多个小的数据包。

粘包拆包可能会导致接收端无法正确解析数据

**解决方案**：通过固定长度消息、分隔符或消息头 + 消息体的方式明确数据包边界。

